{% extends 'core/semestre1/base_semestre1.html' %}
{% load custom_filters %}

{% block title %}SAAL - Analyse des moyennes - Semestre 1{% endblock %}

{% block semestre1_title %}Analyse des moyennes - Semestre 1{% endblock %}
{% block semestre1_subtitle %}
    Année scolaire {{ etablissement.annee_scolaire_active }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<style>
    .stat-card {
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 24px;
    }
    
    .bg-light-primary {
        background-color: rgba(59, 125, 221, 0.1);
        color: #3b7ddd;
    }
    
    .bg-light-success {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    
    .bg-light-danger {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .bg-light-warning {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }
    
    .bg-light-info {
        background-color: rgba(13, 202, 240, 0.1);
        color: #0dcaf0;
    }
    
    .bg-light-secondary {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    .progress-sm {
        height: 6px;
        margin-top: 5px;
    }
    
    .mini-chart {
        width: 100%;
        height: 70px;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .card {
        margin-bottom: 15px;
    }
    
    .dashboard-section {
        margin-bottom: 25px;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
        color: #495057;
    }
    
    .badge-rounded {
        border-radius: 30px;
        padding: 0.35em 0.8em;
    }
    
    .dashboard-summary {
        margin-bottom: 0;
    }
    
    .dashboard-summary .list-group-item {
        padding: 0.55rem 1rem;
        border: none;
        background-color: transparent;
    }
    
    .dashboard-summary .badge {
        font-size: 0.8rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block semestre1_content %}
<!-- Filtres -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0 text-primary"><i class="fas fa-filter me-2"></i>Filtres</h5>
    </div>
    <div class="card-body">
        <form method="get" id="filtres-form" class="row g-2 align-items-end">
            <div class="col-md-2">
                <label for="niveau" class="form-label small">Niveau</label>
                <select class="form-select form-select-sm" id="niveau" name="niveau">
                    <option value="">Tous les niveaux</option>
                    {% for niveau in niveaux %}
                    <option value="{{ niveau.id }}" {% if selected_niveau == niveau.id|stringformat:"s" %}selected{% endif %}>
                        {{ niveau.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="classe" class="form-label small">Classe</label>
                <select class="form-select form-select-sm" id="classe" name="classe">
                    <option value="">Toutes les classes</option>
                    {% for classe in classes %}
                    <option value="{{ classe.id }}" {% if selected_classe == classe.id|stringformat:"s" %}selected{% endif %}>
                        {{ classe.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="import" class="form-label small">Importation</label>
                <select class="form-select form-select-sm" id="import" name="import">
                    <option value="">Toutes les importations</option>
                    {% for import in imports %}
                    <option value="{{ import.id }}" {% if selected_import == import.id|stringformat:"s" %}selected{% endif %}>
                        {{ import.titre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="sexe" class="form-label small">Sexe</label>
                <select class="form-select form-select-sm" id="sexe" name="sexe">
                    <option value="">Tous</option>
                    <option value="M" {% if selected_sexe == "M" %}selected{% endif %}>Masculin</option>
                    <option value="F" {% if selected_sexe == "F" %}selected{% endif %}>Féminin</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="intervalle" class="form-label small">Intervalle de moyenne</label>
                <select class="form-select form-select-sm" id="intervalle" name="intervalle">
                    <option value="">Tous</option>
                    <option value="excellence" {% if selected_intervalle == "excellence" %}selected{% endif %}>Excellence (≥ 16)</option>
                    <option value="tres_bien" {% if selected_intervalle == "tres_bien" %}selected{% endif %}>Très bien (14-15.99)</option>
                    <option value="bien" {% if selected_intervalle == "bien" %}selected{% endif %}>Bien (12-13.99)</option>
                    <option value="assez_bien" {% if selected_intervalle == "assez_bien" %}selected{% endif %}>Assez bien (10-11.99)</option>
                    <option value="passable" {% if selected_intervalle == "passable" %}selected{% endif %}>Passable (8-9.99)</option>
                    <option value="insuffisant" {% if selected_intervalle == "insuffisant" %}selected{% endif %}>Insuffisant (< 8)</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="filtre-actions" class="form-label small">&nbsp;</label>
                <div class="d-flex gap-2" id="filtre-actions">
                    <button type="submit" class="btn btn-sm btn-primary flex-fill h-100" style="height: 40px !important;">
                        <i class="fas fa-search me-1"></i>Filtrer
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary flex-fill h-100" style="height: 40px !important;" onclick="resetFilters()">
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if stats %}
<!-- Éléments cachés pour stocker les informations d'exportation -->
<div id="etablissement-info" style="display: none;"
     data-nom="{{ etablissement.nom }}"
     data-adresse="{{ etablissement.adresse|default:'' }}"
     data-annee-scolaire="{{ etablissement.annee_scolaire_active }}">
</div>

<!-- Informations sur les filtres appliqués -->
<div id="filtre-info" style="display: none;"
     data-niveau="{% for niveau in niveaux %}{% if selected_niveau == niveau.id|stringformat:'s' %}{{ niveau.nom }}{% endif %}{% endfor %}"
     data-classe="{% for classe in classes %}{% if selected_classe == classe.id|stringformat:'s' %}{{ classe.nom }}{% endif %}{% endfor %}"
     data-sexe="{{ selected_sexe|default:'' }}"
     data-intervalle="{{ selected_intervalle|default:'' }}"
     data-import="{% for import in imports %}{% if selected_import == import.id|stringformat:'s' %}{{ import.titre }}{% endif %}{% endfor %}">
</div>

<!-- Statistiques de synthèse -->
<div id="stats-info" style="display: none;"
     data-effectif="{{ stats.nb_eleves }}"
     data-moyenne-generale="{{ stats.moyenne_globale|floatformat:2 }}"
     data-taux-reussite="{{ stats.taux_reussite.pourcentage|floatformat:1 }}"
     data-min-moyenne="{{ stats.min_moyenne|floatformat:2 }}"
     data-max-moyenne="{{ stats.max_moyenne|floatformat:2 }}">
</div>

<!-- Tableau de bord -->
<div class="dashboard-section">
    <!-- Section 1: Statistiques générales -->
    <div class="row g-3">
        <!-- Effectif total -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-primary me-3">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Effectif total</h6>
                            <h3 class="fw-bold mb-0">{{ stats.nb_eleves }}</h3>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">
                            {% if stats.sexe.M > 0 or stats.sexe.F > 0 %}
                            <i class="fas fa-male text-primary"></i> {{ stats.sexe.M }} 
                            ({% if stats.nb_eleves > 0 %}{{ stats.sexe.M|div:stats.nb_eleves|floatformat:1 }}{% else %}0{% endif %}%)
                            <i class="fas fa-female text-danger ms-2"></i> {{ stats.sexe.F }}
                            ({% if stats.nb_eleves > 0 %}{{ stats.sexe.F|div:stats.nb_eleves|floatformat:1 }}{% else %}0{% endif %}%)
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Moyenne générale -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-info me-3">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Moyenne générale</h6>
                            <h3 class="fw-bold mb-0">{{ stats.moyenne_globale|floatformat:2 }}</h3>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Min: {{ stats.min_moyenne|floatformat:2 }}</span>
                        <span class="small text-muted">Max: {{ stats.max_moyenne|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Taux de réussite -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-success me-3">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Taux de réussite</h6>
                            <h3 class="fw-bold mb-0">{{ stats.taux_reussite.pourcentage|floatformat:1 }}%</h3>
                        </div>
                    </div>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-success" style="width: {{ stats.taux_reussite.pourcentage }}%"></div>
                    </div>
                    <div class="mt-1 d-flex justify-content-between">
                        <span class="small text-muted">{{ stats.taux_reussite.nombre }} élèves ≥ 10</span>
                        <span class="small text-muted">
                            <i class="fas fa-male text-primary"></i> {{ stats.taux_reussite.par_sexe.M|default:0 }} 
                            ({% if stats.sexe.M > 0 %}{{ stats.taux_reussite.par_sexe.M|div:stats.sexe.M|floatformat:1 }}{% else %}0{% endif %}%)
                            <i class="fas fa-female text-danger ms-1"></i> {{ stats.taux_reussite.par_sexe.F|default:0 }}
                            ({% if stats.sexe.F > 0 %}{{ stats.taux_reussite.par_sexe.F|div:stats.sexe.F|floatformat:1 }}{% else %}0{% endif %}%)
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Absences & Retards -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-warning me-3">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Assiduité</h6>
                            <h3 class="fw-bold mb-0">{{ stats.absences.total|floatformat:0 }}</h3>
                        </div>
                    </div>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-warning" style="width: {% if stats.absences.max > 0 %}{{ stats.absences.total|div:stats.absences.max }}{% else %}0{% endif %}%"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span class="small text-muted">Abs. totales</span>
                        <span class="small text-muted">{{ stats.retards.total|floatformat:0 }} retards</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Section 2: Répartition & Distribution -->
<div class="dashboard-section">
    <div class="row">
        <!-- Distribution des moyennes -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-chart-pie me-2"></i>Distribution des moyennes</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="chartDistribution" class="chart-container"></canvas>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-group dashboard-summary">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Excellence (≥ 16)</span>
                                    <span class="badge bg-primary badge-rounded">{{ stats.repartition.excellence }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Très bien (14-15.99)</span>
                                    <span class="badge bg-success badge-rounded">{{ stats.repartition.tres_bien }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Bien (12-13.99)</span>
                                    <span class="badge bg-info badge-rounded">{{ stats.repartition.bien }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Assez bien (10-11.99)</span>
                                    <span class="badge bg-warning badge-rounded">{{ stats.repartition.assez_bien }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Passable (8-9.99)</span>
                                    <span class="badge bg-secondary badge-rounded">{{ stats.repartition.passable }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Insuffisant (< 8)</span>
                                    <span class="badge bg-danger badge-rounded">{{ stats.repartition.insuffisant }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top 5 des élèves -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-trophy me-2"></i>Top 5 des élèves</h5>
                </div>
                <div class="card-body">
                    {% if stats.top_eleves %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Classe</th>
                                    <th class="text-end">Moyenne</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eleve in stats.top_eleves %}
                                <tr>
                                    <td><span class="badge bg-primary">{{ eleve.rang }}</span></td>
                                    <td>{{ eleve.nom }}</td>
                                    <td>
                                        {% if eleve.prenom %}
                                            {{ eleve.prenom }}
                                        {% elif eleve.donnees_additionnelles.Prénom %}
                                            {{ eleve.donnees_additionnelles.Prénom }}
                                        {% elif eleve.donnees_additionnelles.prénom %}
                                            {{ eleve.donnees_additionnelles.prénom }}
                                        {% elif eleve.donnees_additionnelles.Prenom %}
                                            {{ eleve.donnees_additionnelles.Prenom }}
                                        {% elif eleve.donnees_additionnelles.prenom %}
                                            {{ eleve.donnees_additionnelles.prenom }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if eleve.classe_obj %}
                                            {{ eleve.classe_obj.nom }}
                                        {% elif eleve.classe_texte %}
                                            {{ eleve.classe_texte }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bold">{{ eleve.moyenne_generale|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center my-4">Aucune donnée disponible</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section 3: Comparaisons par niveau et disciplines -->
<div class="dashboard-section">
    <div class="row">
        {% if stats.moyennes_par_niveau %}
        <!-- Comparaison par niveau -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-chart-bar me-2"></i>Moyennes par niveau</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartNiveaux" class="chart-container"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Décisions du conseil -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-tasks me-2"></i>Décisions du conseil</h5>
                </div>
                <div class="card-body">
                    {% if stats.decisions %}
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="chartDecisions" class="chart-container"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Décision</th>
                                            <th class="text-end">Nombre</th>
                                            <th class="text-end">Pourcentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for decision, count in stats.decisions.items %}
                                        <tr>
                                            <td>{{ decision }}</td>
                                            <td class="text-end">{{ count }}</td>
                                            <td class="text-end">
                                                {% if stats.nb_eleves > 0 %}
                                                    {{ count|div:stats.nb_eleves|floatformat:1 }}%
                                                {% else %}
                                                    0%
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-center my-4">Aucune donnée disponible</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Section 4: Informations complémentaires -->
<div class="dashboard-section">
    <div class="row">
        <!-- Informations complémentaires -->
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-info-circle me-2"></i>Informations complémentaires</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Appréciations -->
                        {% if stats.appreciations %}
                        <div class="col-md-6">
                            <h6 class="section-title"><i class="fas fa-star me-2 text-warning"></i>Appréciations</h6>
                            <div class="row">
                                {% for appreciation, count in stats.appreciations.items %}
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>{{ appreciation }}</span>
                                        <span class="badge bg-info badge-rounded">{{ count }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Notes Min/Max -->
                        <div class="col-md-6">
                            <h6 class="section-title"><i class="fas fa-chart-line me-2 text-primary"></i>Notes Min/Max</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6 text-center">
                                            <h3 class="text-primary mb-0">{{ stats.min_moyenne|floatformat:2 }}</h3>
                                            <p class="text-muted mb-0 small">Note minimale</p>
                                        </div>
                                        <div class="col-6 text-center">
                                            <h3 class="text-success mb-0">{{ stats.max_moyenne|floatformat:2 }}</h3>
                                            <p class="text-muted mb-0 small">Note maximale</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tableau des élèves -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary"><i class="fas fa-table me-2"></i>Liste complète des élèves</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadTableAsCSV()">
                    <i class="fas fa-file-csv me-1"></i>Exporter CSV
                </button>
                <button class="btn btn-sm btn-outline-success me-2" onclick="downloadTableAsExcel()">
                    <i class="fas fa-file-excel me-1"></i>Exporter Excel
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="printTable()">
                    <i class="fas fa-print me-1"></i>Imprimer
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if moyennes %}
        <div class="table-responsive">
            <table id="table-moyennes" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Rang</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Classe</th>
                        <th>Sexe</th>
                        <th class="text-end">Moyenne</th>
                        <th>Décision</th>
                        <th>Absences</th>
                        <th>Retards</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in moyennes %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ eleve.nom }}</td>
                        <td>
                            {% if eleve.prenom %}
                                {{ eleve.prenom }}
                            {% elif eleve.donnees_additionnelles.Prénom %}
                                {{ eleve.donnees_additionnelles.Prénom }}
                            {% elif eleve.donnees_additionnelles.prénom %}
                                {{ eleve.donnees_additionnelles.prénom }}
                            {% elif eleve.donnees_additionnelles.Prenom %}
                                {{ eleve.donnees_additionnelles.Prenom }}
                            {% elif eleve.donnees_additionnelles.prenom %}
                                {{ eleve.donnees_additionnelles.prenom }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if eleve.classe_obj %}
                                {{ eleve.classe_obj.nom }}
                            {% else %}
                                {{ eleve.classe_texte|default:"-" }}
                            {% endif %}
                        </td>
                        <td>
                            {% if 'Sexe' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Sexe }}
                            {% elif 'sexe' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.sexe }}
                            {% elif 'Genre' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Genre }}
                            {% elif 'genre' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.genre }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-end fw-bold">{{ eleve.moyenne_generale|floatformat:2 }}</td>
                        <td>
                            {% if 'Décision conseil' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles|get_item:'Décision conseil' }}
                            {% elif 'Décision du conseil' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles|get_item:'Décision du conseil' }}
                            {% elif 'Décision' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Décision }}
                            {% elif 'Decision' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Decision }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if 'Absence' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Absence }}
                            {% elif 'Absences' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Absences }}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {% if 'Retard' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Retard }}
                            {% elif 'Retards' in eleve.donnees_additionnelles %}
                                {{ eleve.donnees_additionnelles.Retards }}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Aucune donnée disponible. Veuillez sélectionner des filtres différents ou importer des données.
        </div>
        {% endif %}
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    Aucune importation de données n'a été effectuée pour le Semestre 1. Veuillez d'abord <a href="{% url 'core:semestre1_importation' %}" class="alert-link">importer des données</a>.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
$(document).ready(function() {
    // Initialiser DataTables
    $('#table-moyennes').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/fr-FR.json'
        },
        responsive: true,
        dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>t<"d-flex justify-content-between align-items-center"<"d-flex"i><"d-flex"p>>',
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tous"]],
        order: [[5, 'desc']], // Trier par moyenne décroissante (colonne 5)
        pageLength: 25
    });
    
    // Initialiser le graphique de distribution des moyennes
    {% if stats and stats.repartition %}
    const ctxDistribution = document.getElementById('chartDistribution').getContext('2d');
    new Chart(ctxDistribution, {
        type: 'doughnut',
        data: {
            labels: ['Excellence', 'Très bien', 'Bien', 'Assez bien', 'Passable', 'Insuffisant'],
            datasets: [{
                data: [
                    {{ stats.repartition.excellence }},
                    {{ stats.repartition.tres_bien }},
                    {{ stats.repartition.bien }},
                    {{ stats.repartition.assez_bien }},
                    {{ stats.repartition.passable }},
                    {{ stats.repartition.insuffisant }}
                ],
                backgroundColor: [
                    '#3b7ddd',
                    '#28a745',
                    '#0dcaf0',
                    '#ffc107',
                    '#6c757d',
                    '#dc3545'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.label || '';
                            var value = context.raw || 0;
                            var total = context.dataset.data.reduce((a, b) => a + b, 0);
                            var percentage = Math.round(value / total * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Initialiser le graphique des moyennes par niveau
    {% if stats.moyennes_par_niveau and stats.moyennes_par_niveau.labels %}
    const ctxNiveaux = document.getElementById('chartNiveaux').getContext('2d');
    new Chart(ctxNiveaux, {
        type: 'bar',
        data: {
            labels: [{% for label in stats.moyennes_par_niveau.labels %}"{{ label }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Moyenne générale par niveau',
                data: [{% for val in stats.moyennes_par_niveau.data %}{{ val }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: 'rgba(59, 125, 221, 0.7)',
                borderColor: '#3b7ddd',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.max(0, Math.min({% for val in stats.moyennes_par_niveau.data %}{{ val }}{% if not forloop.last %}, {% endif %}{% endfor %}) - 2),
                    max: Math.max({% for val in stats.moyennes_par_niveau.data %}{{ val }}{% if not forloop.last %}, {% endif %}{% endfor %}) + 1,
                    ticks: {
                        precision: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return tooltipItems[0].label;
                        },
                        label: function(context) {
                            var label = context.dataset.label || '';
                            var value = context.raw || 0;
                            return `${label}: ${value.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Initialiser le graphique des décisions du conseil
    {% if stats.decisions %}
    const ctxDecisions = document.getElementById('chartDecisions').getContext('2d');
    new Chart(ctxDecisions, {
        type: 'pie',
        data: {
            labels: [
                {% for decision, count in stats.decisions.items %}
                "{{ decision }}",
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for decision, count in stats.decisions.items %}
                    {{ count }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#3b7ddd', '#28a745', '#0dcaf0', '#ffc107', '#6c757d', '#dc3545',
                    '#7952b3', '#20c997', '#17a2b8', '#fd7e14', '#e83e8c', '#6610f2'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.label || '';
                            var value = context.raw || 0;
                            var total = context.dataset.data.reduce((a, b) => a + b, 0);
                            var percentage = Math.round(value / total * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
});

// Fonction pour réinitialiser les filtres
function resetFilters() {
    document.getElementById('niveau').value = '';
    document.getElementById('classe').value = '';
    document.getElementById('import').value = '';
    document.getElementById('sexe').value = '';
    document.getElementById('intervalle').value = '';
    document.getElementById('filtres-form').submit();
}

// Fonction pour exporter le tableau en CSV avec en-tête d'informations
function downloadTableAsCSV() {
    // Récupérer les informations de filtrage et d'établissement
    const etablissementInfo = document.getElementById('etablissement-info').dataset;
    const filtreInfo = document.getElementById('filtre-info').dataset;
    
    let csv = [];
    
    // Ajouter les informations d'en-tête
    csv.push('"Système d\'Analyse Académique Local"');
    csv.push('"Analyse des moyennes - Semestre 1"');
    csv.push('"' + new Date().toLocaleDateString() + '"');
    csv.push('""');
    
    // Informations sur l'établissement et l'année scolaire
    csv.push('"Établissement: ' + etablissementInfo.nom + '"');
    csv.push('"Année scolaire: ' + etablissementInfo.anneeScolaire + '"');
    
    // Informations sur les filtres appliqués
    csv.push('"Filtres appliqués:"');
    if (filtreInfo.niveau) csv.push('"Niveau: ' + filtreInfo.niveau + '"');
    if (filtreInfo.classe) csv.push('"Classe: ' + filtreInfo.classe + '"');
    if (filtreInfo.sexe) csv.push('"Sexe: ' + (filtreInfo.sexe === 'M' ? 'Masculin' : 'Féminin') + '"');
    if (filtreInfo.intervalle) {
        let intervalleLabel = '';
        switch(filtreInfo.intervalle) {
            case 'excellence': intervalleLabel = 'Excellence (≥ 16)'; break;
            case 'tres_bien': intervalleLabel = 'Très bien (14-15.99)'; break;
            case 'bien': intervalleLabel = 'Bien (12-13.99)'; break;
            case 'assez_bien': intervalleLabel = 'Assez bien (10-11.99)'; break;
            case 'passable': intervalleLabel = 'Passable (8-9.99)'; break;
            case 'insuffisant': intervalleLabel = 'Insuffisant (< 8)'; break;
        }
        csv.push('"Intervalle: ' + intervalleLabel + '"');
    }
    csv.push('""');
    
    // Statistiques de synthèse
    const statsInfo = document.getElementById('stats-info').dataset;
    csv.push('"Statistiques de synthèse:"');
    csv.push('"Effectif total: ' + statsInfo.effectif + '"');
    csv.push('"Moyenne générale: ' + statsInfo.moyenneGenerale + '"');
    csv.push('"Taux de réussite: ' + statsInfo.tauxReussite + '%"');
    csv.push('""');
    
    // Données du tableau
    const table = document.getElementById('table-moyennes');
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        // Ne sélectionner que les lignes visibles
        if (rows[i].style.display !== 'none') {
            const row = [], cols = rows[i].querySelectorAll('td, th');
            
            for (let j = 0; j < cols.length; j++) {
                // Nettoyer les données
                let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/"/g, '""');
                row.push('"' + data + '"');
            }
            
            csv.push(row.join(','));
        }
    }
    
    // Télécharger le CSV
    const csvFile = new Blob([csv.join('\n')], {type: 'text/csv'});
    const downloadLink = document.createElement('a');
    
    // Nom du fichier avec date et informations de filtre
    let fileName = 'Analyse_Moyennes_S1_' + new Date().toISOString().slice(0,10);
    if (filtreInfo.classe) fileName += '_' + filtreInfo.classe.replace(/\s+/g, '_');
    if (filtreInfo.niveau) fileName += '_' + filtreInfo.niveau.replace(/\s+/g, '_');
    fileName += '.csv';
    
    downloadLink.download = fileName;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

// Fonction pour exporter en Excel (XLSX)
function downloadTableAsExcel() {
    // Récupérer les informations de filtrage et d'établissement
    const etablissementInfo = document.getElementById('etablissement-info').dataset;
    const filtreInfo = document.getElementById('filtre-info').dataset;
    const statsInfo = document.getElementById('stats-info').dataset;
    
    // Création d'un nouveau workbook
    const wb = XLSX.utils.book_new();
    
    // Données d'en-tête
    const headerData = [
        ['Système d\'Analyse Académique Local'],
        ['Analyse des moyennes - Semestre 1'],
        [new Date().toLocaleDateString()],
        [''],
        ['Établissement:', etablissementInfo.nom],
        ['Année scolaire:', etablissementInfo.anneeScolaire],
        [''],
        ['Filtres appliqués:']
    ];
    
    // Ajouter les filtres
    if (filtreInfo.niveau) headerData.push(['Niveau:', filtreInfo.niveau]);
    if (filtreInfo.classe) headerData.push(['Classe:', filtreInfo.classe]);
    if (filtreInfo.sexe) headerData.push(['Sexe:', filtreInfo.sexe === 'M' ? 'Masculin' : 'Féminin']);
    if (filtreInfo.intervalle) {
        let intervalleLabel = '';
        switch(filtreInfo.intervalle) {
            case 'excellence': intervalleLabel = 'Excellence (≥ 16)'; break;
            case 'tres_bien': intervalleLabel = 'Très bien (14-15.99)'; break;
            case 'bien': intervalleLabel = 'Bien (12-13.99)'; break;
            case 'assez_bien': intervalleLabel = 'Assez bien (10-11.99)'; break;
            case 'passable': intervalleLabel = 'Passable (8-9.99)'; break;
            case 'insuffisant': intervalleLabel = 'Insuffisant (< 8)'; break;
        }
        headerData.push(['Intervalle:', intervalleLabel]);
    }
    
    headerData.push(['']);
    headerData.push(['Statistiques de synthèse:']);
    headerData.push(['Effectif total:', statsInfo.effectif]);
    headerData.push(['Moyenne générale:', statsInfo.moyenneGenerale]);
    headerData.push(['Taux de réussite:', statsInfo.tauxReussite + '%']);
    headerData.push(['']);
    
    // Créer une feuille pour les en-têtes
    const wsInfo = XLSX.utils.aoa_to_sheet(headerData);
    
    // Récupérer les données du tableau
    const table = document.getElementById('table-moyennes');
    const wsData = XLSX.utils.table_to_sheet(table);
    
    // Ajuster le range pour commencer après les en-têtes
    const range = XLSX.utils.decode_range(wsData['!ref']);
    const headerRows = headerData.length;
    
    // Créer une nouvelle feuille pour les données combinées
    const ws = XLSX.utils.aoa_to_sheet(headerData);
    
    // Placer les données du tableau après les en-têtes
    for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
            const cell_address = XLSX.utils.encode_cell({r:R, c:C});
            if(!wsData[cell_address]) continue;
            
            const new_address = XLSX.utils.encode_cell({r:R+headerRows, c:C});
            ws[new_address] = wsData[cell_address];
        }
    }
    
    // Ajuster le range de la feuille
    const new_range = XLSX.utils.decode_range(ws['!ref']);
    new_range.e.r = range.e.r + headerRows;
    ws['!ref'] = XLSX.utils.encode_range(new_range);
    
    // Ajouter la feuille au workbook
    XLSX.utils.book_append_sheet(wb, ws, "Moyennes Semestre 1");
    
    // Nom du fichier avec date et informations de filtre
    let fileName = 'Analyse_Moyennes_S1_' + new Date().toISOString().slice(0,10);
    if (filtreInfo.classe) fileName += '_' + filtreInfo.classe.replace(/\s+/g, '_');
    if (filtreInfo.niveau) fileName += '_' + filtreInfo.niveau.replace(/\s+/g, '_');
    fileName += '.xlsx';
    
    // Exporter le fichier
    XLSX.writeFile(wb, fileName);
}

// Fonction pour imprimer le tableau avec en-tête d'informations
function printTable() {
    // Récupérer les informations de filtrage et d'établissement
    const etablissementInfo = document.getElementById('etablissement-info').dataset;
    const filtreInfo = document.getElementById('filtre-info').dataset;
    const statsInfo = document.getElementById('stats-info').dataset;
    
    const printContents = document.getElementById('table-moyennes').outerHTML;
    const originalContents = document.body.innerHTML;
    
    // Construire la section d'informations pour l'impression
    let filterInfoHtml = '';
    if (filtreInfo.niveau) filterInfoHtml += '<div><strong>Niveau:</strong> ' + filtreInfo.niveau + '</div>';
    if (filtreInfo.classe) filterInfoHtml += '<div><strong>Classe:</strong> ' + filtreInfo.classe + '</div>';
    if (filtreInfo.sexe) filterInfoHtml += '<div><strong>Sexe:</strong> ' + (filtreInfo.sexe === 'M' ? 'Masculin' : 'Féminin') + '</div>';
    if (filtreInfo.intervalle) {
        let intervalleLabel = '';
        switch(filtreInfo.intervalle) {
            case 'excellence': intervalleLabel = 'Excellence (≥ 16)'; break;
            case 'tres_bien': intervalleLabel = 'Très bien (14-15.99)'; break;
            case 'bien': intervalleLabel = 'Bien (12-13.99)'; break;
            case 'assez_bien': intervalleLabel = 'Assez bien (10-11.99)'; break;
            case 'passable': intervalleLabel = 'Passable (8-9.99)'; break;
            case 'insuffisant': intervalleLabel = 'Insuffisant (< 8)'; break;
        }
        filterInfoHtml += '<div><strong>Intervalle:</strong> ' + intervalleLabel + '</div>';
    }
    
    document.body.innerHTML = `
        <html>
            <head>
                <title>Analyse des moyennes - Semestre 1</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: Opx; }
                    h1 { font-size: 18px; margin-bottom: 10px; }
                    .print-header { margin-bottom: 20px; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                    th { background-color: #f8f9fa; }
                    .header-info { display: flex; justify-content: space-between; margin-bottom: 15px; }
                    .info-section { margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; background-color: #f8f9fa; }
                    .info-title { font-weight: bold; margin-bottom: 5px; }
                    @media print {
                        .page-break { page-break-before: always; }
                    }
                </style>
            </head>
            <body>
                <div class="print-header">
                    <div class="header-info">
                        <div>
                            <h1>SAAL - Analyse des moyennes - Semestre 1</h1>
                            <div>${etablissementInfo.nom}</div>
                            <div>Année scolaire: ${etablissementInfo.anneeScolaire}</div>
                        </div>
                        <div>
                            <div>Date d'impression: ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-section">
                                <div class="info-title">Filtres appliqués</div>
                                ${filterInfoHtml}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-section">
                                <div class="info-title">Statistiques</div>
                                <div><strong>Effectif total:</strong> ${statsInfo.effectif}</div>
                                <div><strong>Moyenne générale:</strong> ${statsInfo.moyenneGenerale}</div>
                                <div><strong>Taux de réussite:</strong> ${statsInfo.tauxReussite}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${printContents}
            </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContents;
    
    // Réinitialiser les fonctionnalités JavaScript après l'impression
    // (nécessaire car le DOM a été remplacé)
    setTimeout(function() {
        location.reload();
    }, 100);
}
</script>
{% endblock %}