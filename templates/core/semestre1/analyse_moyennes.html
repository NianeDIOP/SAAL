{% extends 'core/semestre1/base_semestre1.html' %}
{% load custom_filters %}

{% block title %}SAAL - Analyse des moyennes - Semestre 1{% endblock %}

{% block semestre1_title %}Analyse des moyennes - Semestre 1{% endblock %}
{% block semestre1_subtitle %}
    Année scolaire {{ etablissement.annee_scolaire_active }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<style>
    .stat-card {
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 24px;
    }
    
    .bg-light-primary {
        background-color: rgba(59, 125, 221, 0.1);
        color: #3b7ddd;
    }
    
    .bg-light-success {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    
    .bg-light-danger {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .bg-light-warning {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }
    
    .bg-light-info {
        background-color: rgba(13, 202, 240, 0.1);
        color: #0dcaf0;
    }
    
    .bg-light-secondary {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    .progress-sm {
        height: 6px;
        margin-top: 5px;
    }
    
    .mini-chart {
        width: 100%;
        height: 70px;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .card {
        margin-bottom: 15px;
    }
    
    .dashboard-section {
        margin-bottom: 25px;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
        color: #495057;
    }
    
    .badge-rounded {
        border-radius: 30px;
        padding: 0.35em 0.8em;
    }
    
    .dashboard-summary {
        margin-bottom: 0;
    }
    
    .dashboard-summary .list-group-item {
        padding: 0.55rem 1rem;
        border: none;
        background-color: transparent;
    }
    
    .dashboard-summary .badge {
        font-size: 0.8rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block semestre1_content %}
<!-- Filtres -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0 text-primary"><i class="fas fa-filter me-2"></i>Filtres</h5>
    </div>
    <div class="card-body">
        <form method="get" id="filtres-form" class="row g-3">
            <div class="col-md-4">
                <label for="niveau" class="form-label">Niveau</label>
                <select class="form-select" id="niveau" name="niveau" onchange="this.form.submit()">
                    <option value="">Tous les niveaux</option>
                    {% for niveau in niveaux %}
                    <option value="{{ niveau.id }}" {% if selected_niveau == niveau.id|stringformat:"s" %}selected{% endif %}>
                        {{ niveau.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="classe" class="form-label">Classe</label>
                <select class="form-select" id="classe" name="classe" onchange="this.form.submit()">
                    <option value="">Toutes les classes</option>
                    {% for classe in classes %}
                    <option value="{{ classe.id }}" {% if selected_classe == classe.id|stringformat:"s" %}selected{% endif %}>
                        {{ classe.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="import" class="form-label">Importation</label>
                <select class="form-select" id="import" name="import" onchange="this.form.submit()">
                    <option value="">Toutes les importations</option>
                    {% for import in imports %}
                    <option value="{{ import.id }}" {% if selected_import == import.id|stringformat:"s" %}selected{% endif %}>
                        {{ import.titre }} ({{ import.date_import|date:"d/m/Y" }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                    <i class="fas fa-times me-2"></i>Réinitialiser les filtres
                </button>
            </div>
        </form>
    </div>
</div>

{% if stats %}
<!-- Tableau de bord -->
<div class="dashboard-section">
    <!-- Section 1: Statistiques générales -->
    <div class="row g-3">
        <!-- Effectif total -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-primary me-3">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Effectif total</h6>
                            <h3 class="fw-bold mb-0">{{ stats.nb_eleves }}</h3>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">
                            {% if stats.sexe.M > 0 or stats.sexe.F > 0 %}
                            <i class="fas fa-male text-primary"></i> {{ stats.sexe.M }} 
                            <i class="fas fa-female text-danger ms-2"></i> {{ stats.sexe.F }}
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Moyenne générale -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-info me-3">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Moyenne générale</h6>
                            <h3 class="fw-bold mb-0">{{ stats.moyenne_globale|floatformat:2 }}</h3>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Min: {{ stats.min_moyenne|floatformat:2 }}</span>
                        <span class="small text-muted">Max: {{ stats.max_moyenne|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Taux de réussite -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-success me-3">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Taux de réussite</h6>
                            <h3 class="fw-bold mb-0">{{ stats.taux_reussite.pourcentage|floatformat:1 }}%</h3>
                        </div>
                    </div>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-success" style="width: {{ stats.taux_reussite.pourcentage }}%"></div>
                    </div>
                    <div class="mt-1 small text-muted">{{ stats.taux_reussite.nombre }} élèves avec moy. ≥ 10</div>
                </div>
            </div>
        </div>
        
        <!-- Absences & Retards -->
        <div class="col-md-3">
            <div class="card stat-card h-100">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <div class="stat-icon bg-light-warning me-3">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0 small">Assiduité</h6>
                            <h3 class="fw-bold mb-0">{{ stats.absences.total|floatformat:0 }}</h3>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Abs. totales</span>
                        <span class="small text-muted">{{ stats.retards.total|floatformat:0 }} retards</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section 2: Répartition & Distribution -->
<div class="dashboard-section">
    <div class="row">
        <!-- Distribution des moyennes -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-chart-pie me-2"></i>Distribution des moyennes</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="chartDistribution" class="chart-container"></canvas>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-group dashboard-summary">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Excellence (≥ 16)</span>
                                    <span class="badge bg-primary badge-rounded">{{ stats.repartition.excellence }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Très bien (14-15.99)</span>
                                    <span class="badge bg-success badge-rounded">{{ stats.repartition.tres_bien }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Bien (12-13.99)</span>
                                    <span class="badge bg-info badge-rounded">{{ stats.repartition.bien }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Assez bien (10-11.99)</span>
                                    <span class="badge bg-warning badge-rounded">{{ stats.repartition.assez_bien }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Passable (8-9.99)</span>
                                    <span class="badge bg-secondary badge-rounded">{{ stats.repartition.passable }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Insuffisant (< 8)</span>
                                    <span class="badge bg-danger badge-rounded">{{ stats.repartition.insuffisant }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top 5 des élèves -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-trophy me-2"></i>Top 5 des élèves</h5>
                </div>
                <div class="card-body">
                    {% if stats.top_eleves %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Rang</th>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Classe</th>
                                    <th class="text-end">Moyenne</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eleve in stats.top_eleves %}
                                <tr>
                                    <td><span class="badge bg-primary">{{ eleve.rang }}</span></td>
                                    <td>{{ eleve.nom_eleve }}</td>
                                    <td>{{ eleve.prenom_eleve|default:"-" }}</td>
                                    <td>{{ eleve.classe.nom }}</td>
                                    <td class="text-end fw-bold">{{ eleve.moyenne_generale|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center my-4">Aucune donnée disponible</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section 3: Comparaisons par niveau et disciplines -->
<div class="dashboard-section">
    <div class="row">
        {% if stats.moyennes_par_niveau %}
        <!-- Comparaison par niveau -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-chart-bar me-2"></i>Moyennes par niveau</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartNiveaux" class="chart-container"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Informations complémentaires -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="fas fa-info-circle me-2"></i>Informations complémentaires</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Appréciations -->
                        {% if stats.appreciations %}
                        <div class="col-md-6">
                            <h6 class="section-title"><i class="fas fa-star me-2 text-warning"></i>Appréciations</h6>
                            <ul class="list-group dashboard-summary">
                                {% for appreciation, count in stats.appreciations.items %}
                                <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                                    <span>{{ appreciation }}</span>
                                    <span class="badge bg-info badge-rounded">{{ count }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <!-- Décisions du conseil -->
                        {% if stats.decisions %}
                        <div class="col-md-6">
                            <h6 class="section-title"><i class="fas fa-tasks me-2 text-primary"></i>Décisions</h6>
                            <ul class="list-group dashboard-summary">
                                {% for decision, count in stats.decisions.items %}
                                <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                                    <span>{{ decision }}</span>
                                    <span class="badge bg-secondary badge-rounded">{{ count }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tableau des élèves -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary"><i class="fas fa-table me-2"></i>Liste complète des élèves</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadTableAsCSV()">
                    <i class="fas fa-download me-1"></i>Exporter CSV
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="printTable()">
                    <i class="fas fa-print me-1"></i>Imprimer
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if moyennes %}
        <div class="table-responsive">
            <table id="table-moyennes" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Rang</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Classe</th>
                        <th class="text-end">Moyenne</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in moyennes %}
                    <tr>
                        <td>{{ eleve.rang }}</td>
                        <td>{{ eleve.nom_eleve }}</td>
                        <td>{{ eleve.prenom_eleve|default:"-" }}</td>
                        <td>{{ eleve.classe.nom }}</td>
                        <td class="text-end fw-bold">{{ eleve.moyenne_generale|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Aucune donnée disponible. Veuillez sélectionner des filtres différents ou importer des données.
        </div>
        {% endif %}
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    Aucune importation de données n'a été effectuée pour le Semestre 1. Veuillez d'abord <a href="{% url 'core:semestre1_importation' %}" class="alert-link">importer des données</a>.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
$(document).ready(function() {
    // Initialiser DataTables
    $('#table-moyennes').DataTable({
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/fr-FR.json'
        },
        responsive: true,
        dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>t<"d-flex justify-content-between align-items-center"<"d-flex"i><"d-flex"p>>',
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tous"]],
        order: [[4, 'desc']], // Trier par moyenne décroissante
        pageLength: 25
    });
    
    // Initialiser le graphique de distribution des moyennes
    {% if stats and stats.repartition %}
    const ctxDistribution = document.getElementById('chartDistribution').getContext('2d');
    new Chart(ctxDistribution, {
        type: 'doughnut',
        data: {
            labels: ['Excellence', 'Très bien', 'Bien', 'Assez bien', 'Passable', 'Insuffisant'],
            datasets: [{
                data: [
                    {{ stats.repartition.excellence }},
                    {{ stats.repartition.tres_bien }},
                    {{ stats.repartition.bien }},
                    {{ stats.repartition.assez_bien }},
                    {{ stats.repartition.passable }},
                    {{ stats.repartition.insuffisant }}
                ],
                backgroundColor: [
                    '#3b7ddd',
                    '#28a745',
                    '#0dcaf0',
                    '#ffc107',
                    '#6c757d',
                    '#dc3545'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.label || '';
                            var value = context.raw || 0;
                            var total = context.dataset.data.reduce((a, b) => a + b, 0);
                            var percentage = Math.round(value / total * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Initialiser le graphique des moyennes par niveau
    {% if stats.moyennes_par_niveau %}
    const ctxNiveaux = document.getElementById('chartNiveaux').getContext('2d');
    new Chart(ctxNiveaux, {
        type: 'bar',
        data: {
            labels: {{ stats.moyennes_par_niveau.labels|safe }},
            datasets: [{
                label: 'Moyenne générale',
                data: {{ stats.moyennes_par_niveau.data|safe }},
                backgroundColor: 'rgba(59, 125, 221, 0.7)',
                borderColor: '#3b7ddd',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.max(0, Math.min(... {{ stats.moyennes_par_niveau.data|safe }}) - 2),
                    max: Math.max(... {{ stats.moyennes_par_niveau.data|safe }}) + 1,
                    ticks: {
                        precision: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    {% endif %}
});

// Fonction pour réinitialiser les filtres
function resetFilters() {
    document.getElementById('niveau').value = '';
    document.getElementById('classe').value = '';
    document.getElementById('import').value = '';
    document.getElementById('filtres-form').submit();
}

// Fonction pour exporter le tableau en CSV
function downloadTableAsCSV() {
    const table = document.getElementById('table-moyennes');
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        // Ne sélectionner que les lignes visibles
        if (rows[i].style.display !== 'none') {
            const row = [], cols = rows[i].querySelectorAll('td, th');
            
            for (let j = 0; j < cols.length; j++) {
                // Nettoyer les données
                let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/"/g, '""');
                row.push('"' + data + '"');
            }
            
            csv.push(row.join(','));
        }
    }
    
    // Télécharger le CSV
    const csvFile = new Blob([csv.join('\n')], {type: 'text/csv'});
    const downloadLink = document.createElement('a');
    
    downloadLink.download = 'Analyse_Moyennes_S1_' + new Date().toISOString().slice(0,10) + '.csv';
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

// Fonction pour imprimer le tableau
function printTable() {
    const printContents = document.getElementById('table-moyennes').outerHTML;
    const originalContents = document.body.innerHTML;
    
    document.body.innerHTML = `
        <html>
            <head>
                <title>Analyse des moyennes - Semestre 1</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: 20px; }
                    h1 { font-size: 18px; margin-bottom: 20px; }
                    .print-header { margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <div class="print-header">
                    <h1>Analyse des moyennes - Semestre 1</h1>
                    <p>Date d'impression: ${new Date().toLocaleDateString()}</p>
                </div>
                ${printContents}
            </body>
        </html>
    `;
    
    window.print();
    document.body.innerHTML = originalContents;
}
</script>
{% endblock %}